<script type="text/javascript">
    var btnAddPrescriptionsModal = $("#btnAddPrescriptionsModal");
    var modalSavePrescription = $("#modalSavePrescription");
    var modalPrescriptionDetail = $("#modalPrescriptionDetail");
    var modalDismissedPrescriptions = $("#modalDismissedPrescriptions");
    var frmSavePrescription = $("#frmSavePrescription");
    var txtPrescriptionSearch = $("#txtPrescriptionSearch");

    $(document).ready(function () {
        loadPrescriptions();
        modalPrescriptionDetail.popup({
            autozindex: true,
            scrolllock: true
        });
        modalDismissedPrescriptions.popup({
            autozindex: true,
            scrolllock: true
        });

        btnAddPrescriptionsModal.on('click', function (e) {
            e.preventDefault();

            modalSavePrescription.modal('show');
        });

        frmSavePrescription.on('submit', function (e) {
            e.preventDefault();
            savePrescription();
        });

        txtPrescriptionSearch.on('keydown', function(e){
            searchPrescriptions();
        });

    });

    function loadPrescriptions(){
        var url = "{% url 'api_private_appointment_prescription_list' %}?checkup_id={{ checkup.id }}";
        $.get(url)
            .done(function(result){
                console.log(result);
                $("#prescriptions-container").loadTemplate($("#prescriptions-template"), result);

                $(".prescription-detail").on('click', function(e){
                    e.preventDefault();
                    console.log($(this).attr("data-prescription-name"));
                    $("#modalPrescriptionDetailTitle").html($(this).attr("data-prescription-name"));
                    $("#modalPrescriptionDetailDescription").html($(this).attr("data-prescription-description"));
                });

                $(".remove-prescription").on('click', function(e){
                    e.preventDefault();
                    var prescription_id = $(this).attr("data-prescription-id");
                    removePrescription(prescription_id);
                });
            });

        var dismissed_url = "{% url 'api_private_appointment_prescription_dismissed_list' %}?checkup_id={{ checkup.id }}";
        $.get(dismissed_url)
            .done(function(result){
                $("#dismissed-prescriptions-container").loadTemplate($("#dismissed-prescriptions-template"), result);
            })
    }

    function searchPrescriptions() {
        var term = txtPrescriptionSearch.val();
        var url = "{% url 'api_public_prescriptions_list' %}?s=" + term;
        if (term.length >= 2) {
            $.get(url)
                .done(function(result){

                    $("#prescriptions-list-container").loadTemplate($("#prescriptions-list-template"), result);

                    $(".add-prescription").on('click', function(e){
                        e.preventDefault();
                        var prescription_id = $(this).attr("data-prescription-id");
                        addPrescription(prescription_id);

                    });
                })
                .fail(function(result){
                    console.log(result);
                });
        }else{
            $("#prescriptions-list-container").html('');
        }
    }

    function addPrescription(prescription_id){
        var url = "{% url 'api_private_appointment_prescription_create' %}";
        var formData = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            checkup: '{{ checkup.id }}',
            prescription: prescription_id
        };

        $.post(url, formData)
            .done(function(result){
                loadPrescriptions();
                $.notify({
                    message: "Prescription added!"
                }, {
                    type: "success"
                })
            })
            .fail(function(result){
                if(result.status === 409){
                    $.notify({
                        message: result.responseText
                    }, {
                        type: "danger"
                    });
                }else{
                    $.notify({
                        message: "That prescription has already been added! If you don't see it, check the dismissed list."
                    }, {
                        type: "danger"
                    });
                }
            })
    }

    function removePrescription(prescription_id){
        var url = "{% url 'api_private_appointment_prescription_delete' %}?id=" + prescription_id + "&checkup_id={{ checkup.id }}";
        var formData = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
        };

        $.post(url, formData)
            .done(function (result) {
                loadPrescriptions();
                $.notify({
                    message: "Prescription removed!"
                }, {
                    type: 'success'
                });
            });
    }

    function savePrescription() {
        var url = "{% url 'api_private_prescription_create' %}";
        var formData = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            name: $("#id_prescription_name").val(),
            description: $("#id_prescription_description").val()
        };

        $.post(url, formData)
            .done(function (result) {
                addPrescription(result.id);
                $.notify({
                    message: "Prescription created!"
                }, {
                    type: 'success'
                });
            });
        modalSavePrescription.modal('hide');
    }
</script>